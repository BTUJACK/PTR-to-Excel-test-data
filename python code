# ä¸¥æ ¼æ ¡éªŒPython 3.8.7ç‰ˆæœ¬

import re
import tkinter as tk
from tkinter import filedialog, messagebox
import openpyxl
from openpyxl.styles import Alignment, Font
import sys

# ä¸¥æ ¼æ ¡éªŒPython 3.8.7ç‰ˆæœ¬
assert sys.version_info >= (3, 8) and sys.version_info < (3, 9), \
    f"å½“å‰Pythonç‰ˆæœ¬ï¼š{sys.version}ï¼Œè¯·ä½¿ç”¨3.8.7ç‰ˆæœ¬ï¼"

def check_colon_rule(cell_text):
    """
    æ ¡éªŒç¬¬ä¸€åˆ—æ˜¯å¦æ»¡è¶³ï¼šå«å†’å·ï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰ä¸”å†’å·åŽæ— å…¶ä»–å­—ç¬¦
    è¿”å›žï¼šTrue/False
    """
    if not cell_text:
        return False
    
    # ç»Ÿä¸€è½¬ä¸ºå­—ç¬¦ä¸²å¹¶åŽ»é™¤é¦–å°¾ç©ºç™½ï¼Œå…¼å®¹ä¸­è‹±æ–‡å†’å·
    clean_text = str(cell_text).strip()
    # åŒ¹é…â€œä»»æ„å­—ç¬¦+å†’å·+ç»“å°¾â€ï¼ˆå†’å·åŽæ— å†…å®¹ï¼‰
    colon_pattern = re.compile(r'.*[ï¼š:]$')
    if not colon_pattern.match(clean_text):
        return False
    
    # æå–å†’å·åŽçš„å­—ç¬¦ï¼ˆéœ€ä¸ºç©ºï¼‰
    colon_index = clean_text.rfind('ï¼š') if 'ï¼š' in clean_text else clean_text.rfind(':')
    after_colon = clean_text[colon_index+1:].strip()
    return len(after_colon) == 0

def check_number_rule(cell_text):
    """
    æ ¡éªŒç¬¬ä¸€åˆ—æ˜¯å¦æ»¡è¶³ï¼šç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯æ•°å­—ç¬¬äºŒä¸ªå­—ç¬¦ä¸æ˜¯æ‹¬å·
    è¿”å›žï¼šTrue/False
    """
    if not cell_text:
        return False
    
    # ç»Ÿä¸€è½¬ä¸ºå­—ç¬¦ä¸²å¹¶åŽ»é™¤é¦–å°¾ç©ºç™½
    clean_text = str(cell_text).strip()
    if len(clean_text) < 2:
        return False
    
    # ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯æ•°å­—
    first_char_is_digit = clean_text[0].isdigit()
    # ç¬¬äºŒä¸ªå­—ç¬¦ä¸æ˜¯æ‹¬å·ï¼ˆåŒ…å«ä¸­æ–‡/è‹±æ–‡æ‹¬å·ï¼‰
    second_char_not_bracket = clean_text[1] not in ['(', ')', 'ï¼ˆ', 'ï¼‰']
    
    return first_char_is_digit and second_char_not_bracket

def format_target_row(ws, row_num):
    """
    å¯¹ç›®æ ‡è¡Œæ‰§è¡Œæ“ä½œï¼šåŠ ç²—ç¬¬ä¸€åˆ— + åˆå¹¶å‰ä¸‰åˆ— + é å·¦å¯¹é½
    ç¦æ­¢åˆå¹¶å¤šè¡Œï¼Œä»…å¤„ç†å½“å‰è¡Œ
    :param ws: å·¥ä½œè¡¨å¯¹è±¡
    :param row_num: ç›®æ ‡è¡Œå·ï¼ˆä»Ž1å¼€å§‹ï¼‰
    """
    # 1. åŠ ç²—ç¬¬ä¸€åˆ—å•å…ƒæ ¼å†…å®¹
    cell_a = ws[f'A{row_num}']
    cell_a.font = Font(bold=True)  # è®¾ç½®åŠ ç²—
    
    # 2. åˆå¹¶å½“å‰è¡Œçš„å‰ä¸‰åˆ—ï¼ˆA-Cåˆ—ï¼‰ï¼Œä»…åˆå¹¶å½“å‰è¡Œï¼ˆç¦æ­¢åˆå¹¶å¤šè¡Œï¼‰
    ws.merge_cells(f'A{row_num}:C{row_num}')
    
    # 3. è®¾ç½®åˆå¹¶åŽå•å…ƒæ ¼å†…å®¹é å·¦+åž‚ç›´å±…ä¸­å¯¹é½
    merged_cell = ws[f'A{row_num}']
    merged_cell.alignment = Alignment(horizontal='left', vertical='center')

def process_excel(file_path):
    """æ ¸å¿ƒå¤„ç†é€»è¾‘ï¼šä¸¥æ ¼éµå¾ªæ‰€æœ‰è§„åˆ™"""
    try:
        # æ‰“å¼€Excelæ–‡ä»¶ï¼ˆæ”¯æŒ.xlsxæ ¼å¼ï¼‰ï¼Œä¿ç•™åŽŸæœ‰æ ¼å¼
        wb = openpyxl.load_workbook(file_path)
        
        # éåŽ†æ‰€æœ‰å·¥ä½œè¡¨
        for ws_name in wb.sheetnames:
            ws = wb[ws_name]
            # èŽ·å–å·¥ä½œè¡¨æœ€å¤§è¡Œæ•°ï¼ˆé¿å…ç©ºè¡Œå¤„ç†ï¼‰
            max_row = ws.max_row
            
            # éåŽ†è¡Œï¼ˆè·³è¿‡ç¬¬ä¸€è¡Œæ¨¡æ¿è¡Œï¼Œä»Žç¬¬äºŒè¡Œå¼€å§‹ï¼‰
            for row_num in range(2, max_row + 1):
                # èŽ·å–ç¬¬ä¸€åˆ—å•å…ƒæ ¼å†…å®¹ï¼ˆå…¼å®¹æ•°å­—/å­—ç¬¦ä¸²/ç©ºå€¼ï¼‰
                cell_1 = ws[f'A{row_num}']
                cell_1_text = cell_1.value if cell_1.value is not None else ""
                
                # è§„åˆ™1ï¼šç¬¬ä¸€åˆ—å«å†’å·ä¸”å†’å·åŽæ— å…¶ä»–å­—ç¬¦
                rule1 = check_colon_rule(cell_1_text)
                # è§„åˆ™2ï¼šç¬¬ä¸€åˆ—é¦–å­—ç¬¦æ˜¯æ•°å­—ï¼Œç¬¬äºŒä¸ªå­—ç¬¦ä¸æ˜¯æ‹¬å·
                rule2 = check_number_rule(cell_1_text)
                
                # æ»¡è¶³ä»»ä¸€è§„åˆ™åˆ™æ‰§è¡Œæ ¼å¼åŒ–æ“ä½œ
                if rule1 or rule2:
                    format_target_row(ws, row_num)
        
        # ä¿å­˜å¤„ç†åŽçš„æ–‡æ¡£ï¼ˆä¸è¦†ç›–åŽŸæ–‡ä»¶ï¼‰
        save_path = file_path.replace('.xlsx', '_processed.xlsx')
        wb.save(save_path)
        wb.close()
        return save_path
    
    except Exception as e:
        raise Exception(f"Excelå¤„ç†å‡ºé”™ï¼š{str(e)}")

def select_and_process():
    """GUIå›žè°ƒå‡½æ•°ï¼šé€‰æ‹©æ–‡ä»¶å¹¶æ‰§è¡Œå¤„ç†"""
    file_path = filedialog.askopenfilename(
        title="é€‰æ‹©Excelæ–‡æ¡£ï¼ˆä»…æ”¯æŒxlsxæ ¼å¼ï¼‰",
        filetypes=[("Excelæ–‡æ¡£", "*.xlsx"), ("æ‰€æœ‰æ–‡ä»¶", "*.*")]
    )
    if not file_path:
        return
    
    try:
        result_path = process_excel(file_path)
        messagebox.showinfo("å¤„ç†æˆåŠŸ", f"Excelå·²å¤„ç†å®Œæˆï¼\nä¿å­˜è·¯å¾„ï¼š\n{result_path}")
    except Exception as e:
        messagebox.showerror("å¤„ç†å¤±è´¥", f"å‡ºé”™åŽŸå› ï¼š\n{str(e)}")

def create_gui():
    """åˆ›å»ºå¯è§†åŒ–ç”¨æˆ·ç•Œé¢"""
    root = tk.Tk()
    root.title("Excelè‡ªåŠ¨åŒ–å¤„ç†å·¥å…·ï¼ˆPython 3.8.7ï¼‰")
    root.geometry("800x380")
    root.resizable(False, False)
    
    # æ ‡é¢˜
    title_label = tk.Label(
        root,
        text="Excelæ–‡æ¡£è‡ªåŠ¨åŒ–å¤„ç†å·¥å…·",
        font=("å¾®è½¯é›…é»‘", 18, "bold"),
        fg="#2F5496"
    )
    title_label.pack(pady=15)
    
    # è§„åˆ™è¯´æ˜Žï¼ˆæ¸…æ™°å±•ç¤ºæ‰€æœ‰è¦æ±‚ï¼‰
    rule_text = (
        "ðŸ“‹ æ ¸å¿ƒå¤„ç†è§„åˆ™ï¼š\n"
        "1. è·³è¿‡æ¯é¡µ/æ¯ä¸ªå·¥ä½œè¡¨çš„ç¬¬ä¸€è¡Œæ¨¡æ¿è¡Œï¼Œä¸åšä»»ä½•ä¿®æ”¹ï¼›\n"
        "2. æ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶çš„è¡Œï¼ˆåˆ¤æ–­èŒƒå›´ï¼šä»…ç¬¬ä¸€åˆ—ï¼‰ï¼š\n"
        "   - ç¬¬ä¸€åˆ—å«å†’å·ï¼ˆä¸­æ–‡ï¼š/è‹±æ–‡:ï¼‰ä¸”å†’å·åŽæ— ä»»ä½•å­—ç¬¦ï¼ˆå¦‚ï¼šâ€œæ ‡é¢˜ï¼šâ€ï¼Œéžâ€œæ ‡é¢˜ï¼šå†…å®¹â€ï¼‰ï¼›\n"
        "   - ç¬¬ä¸€åˆ—é¦–å­—ç¬¦ä¸ºæ•°å­—ï¼Œä¸”ç¬¬äºŒä¸ªå­—ç¬¦ä¸æ˜¯æ‹¬å·ï¼ˆä¸­æ–‡/è‹±æ–‡æ‹¬å·ï¼‰ï¼›\n"
        "   â†’ åŠ ç²—ç¬¬ä¸€åˆ—å†…å®¹ï¼›\n"
        "   â†’ åˆå¹¶å½“å‰è¡Œçš„å‰ä¸‰åˆ—ï¼ˆA-Cåˆ—ï¼‰ï¼Œç¦æ­¢åˆå¹¶å¤šè¡Œï¼›\n"
        "   â†’ åˆå¹¶åŽçš„å†…å®¹é å·¦+åž‚ç›´å±…ä¸­å¯¹é½ï¼›\n"
        "3. ä»…æ”¯æŒ.xlsxæ ¼å¼ï¼Œå¤„ç†åŽç”Ÿæˆæ–°æ–‡ä»¶ï¼ˆä¸è¦†ç›–åŽŸæ–‡ä»¶ï¼‰ï¼Œæ”¯æŒå¤šå·¥ä½œè¡¨ã€‚"
    )
    rule_label = tk.Label(
        root,
        text=rule_text,
        font=("å¾®è½¯é›…é»‘", 9),
        justify=tk.LEFT,
        wraplength=780,
        fg="#333333"
    )
    rule_label.pack(pady=10)
    
    # å¤„ç†æŒ‰é’®ï¼ˆç¾ŽåŒ–æ ·å¼ï¼‰
    process_btn = tk.Button(
        root,
        text="é€‰æ‹©å¹¶å¤„ç†xlsxæ–‡æ¡£",
        font=("å¾®è½¯é›…é»‘", 12, "bold"),
        bg="#2D8CF0",
        fg="white",
        padx=45,
        pady=12,
        relief=tk.RAISED,
        command=select_and_process
    )
    process_btn.pack(pady=15)
    
    # ç‰ˆæœ¬&æ ¼å¼æç¤º
    version_label = tk.Label(
        root,
        text="é€‚é…Python 3.8.7 | ä»…æ”¯æŒ.xlsxæ ¼å¼ | å¤„ç†åŽä¸è¦†ç›–åŽŸæ–‡ä»¶ | ä¿ç•™åŽŸæœ‰æ ¼å¼ + åŠ ç²—ç¬¬ä¸€åˆ—",
        font=("å¾®è½¯é›…é»‘", 8),
        fg="#999999"
    )
    version_label.pack(pady=5)
    
    root.mainloop()

if __name__ == "__main__":
    # å®‰è£…ä¾èµ–ï¼ˆå¿…é¡»æ‰§è¡Œï¼Œé€‚é…Python 3.8.7ï¼‰
    # pip install openpyxl==3.0.9
    create_gui()
